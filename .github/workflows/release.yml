---
name: Build and Release

'on':
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.1)'
        required: true
        default: 'v1.0.1'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'browser/package-lock.json'

      - name: Install dependencies
        run: |
          cd browser
          npm ci

      - name: Build static site
        run: |
          cd browser
          npm run build

      - name: Create release archive
        run: |
          cd browser/dist
          zip -r ../../eversense-companion-static-site.zip .
          tar -czf ../../eversense-companion-static-site.tar.gz .
          cd ../..

      - name: Get version from tag or input
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Eversense Companion ${{ steps.version.outputs.version }}
          body: |
            ## ðŸ©¸ Eversense Companion - Blood Glucose Monitor

            This release contains the complete static site for the Eversense
            Companion D3.js blood glucose visualization application.

            ### ðŸ“¦ Downloads
            - **eversense-companion-static-site.zip** - Complete static site
              (ZIP format)
            - **eversense-companion-static-site.tar.gz** - Complete static site
              (TAR.GZ format)

            ### ðŸš€ Quick Deployment
            1. Download and extract one of the archives above
            2. Upload the contents to any static web hosting service
            3. Access the application through your web browser
            4. Enter your Eversense credentials to view glucose data

            ### âœ¨ Features
            - Real-time blood glucose monitoring with D3.js charts
            - Color-coded glucose zones (Good: 80-130 mg/dL, High: >130 mg/dL,
              Low: <80 mg/dL)
            - Interactive tooltips and trend indicators
            - Responsive design for desktop and mobile
            - Direct integration with Eversense API

            ### ðŸ”§ Local Development
            ```bash
            # Extract the archive and navigate to the directory
            cd eversense-companion

            # Install dependencies
            npm install

            # Start development server
            npm run dev
            ```

            For detailed setup instructions, see the README.md file included
            in the release.
          files: |
            eversense-companion-static-site.zip
            eversense-companion-static-site.tar.gz
          draft: false
          prerelease: false

  deploy-pages:
    runs-on: ubuntu-latest
    needs: build-and-release
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'browser/package-lock.json'

      - name: Install dependencies
        run: |
          cd browser
          npm ci

      - name: Build static site
        run: |
          cd browser
          npm run build

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: ./browser/dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v3
